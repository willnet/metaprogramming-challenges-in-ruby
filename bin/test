#!/usr/bin/env bash

# Ruby-first テスト実行スクリプト
# Ruby ファイルの変更を JavaScript に同期してからテストを実行します

set -e

# スクリプトのディレクトリを取得
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# プロジェクトルートに移動
cd "$PROJECT_ROOT"

echo "🔄 Syncing Ruby files to JavaScript..."
node scripts/sync-ruby-to-js.js

echo ""
echo "📊 Generating test problems JSON..."
node scripts/generate-test-json.js

echo ""
echo "🧪 Running comprehensive answer tests..."
ruby test/test_answers_comprehensive.rb

# 引数が渡された場合、特定の問題をテスト
if [ $# -eq 2 ]; then
    echo ""
    echo "🎯 Testing specific problem: $1/$2"
    ruby test/test_answers_comprehensive.rb "$1" "$2"
fi

echo ""
echo "🌐 Running E2E browser tests..."

# プロジェクトをビルド
echo "📦 Building project..."
node esbuild.config.js

# テスト用サーバーを開始（ポート8001）
echo "🚀 Starting test server on port 8001..."
cd dist
ruby -run -e httpd . -p 8001 &
SERVER_PID=$!
cd ..

# サーバーの起動を待つ
echo "⏳ Waiting for server to start..."
for i in {1..30}; do
    if curl -s http://localhost:8001 > /dev/null 2>&1; then
        echo "✅ Server is ready!"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "❌ Server failed to start within 30 seconds"
        kill $SERVER_PID 2>/dev/null
        exit 1
    fi
    sleep 1
done

# スクリーンショット用ディレクトリを作成
mkdir -p test/screenshots

# Playwrightのインストール（初回のみ）
if [ ! -d "node_modules/@playwright" ]; then
    echo "📦 Installing Playwright browsers..."
    npx playwright install chromium
fi

# E2Eテストを実行（全問題）
echo "🎭 Running E2E tests..."
npx playwright test test/test_e2e.js --reporter=line

E2E_EXIT_CODE=$?

# サーバーを停止
echo "🛑 Stopping test server..."
kill $SERVER_PID 2>/dev/null
wait $SERVER_PID 2>/dev/null

if [ $E2E_EXIT_CODE -eq 0 ]; then
    echo "✅ E2E tests passed!"
else
    echo "❌ E2E tests failed!"
    exit $E2E_EXIT_CODE
fi

echo ""
echo "✅ All tests completed!"